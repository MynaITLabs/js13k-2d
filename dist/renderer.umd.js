!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Renderer=e()}(this,function(){var t=function(t,e){this.c=t,this.p=null,this.n=e,this.d=!1};t.prototype.remove=function(){this.d=!0};var e=function(){this.h=null};e.prototype.add=function(e){var n=new t(e,this.h);return this.h&&(this.h.p=n),this.h=n,n},e.prototype.iterate=function(t){for(var e=this.h;e;)e.d?(e.p?e.p.n=e.n:this.h=e.n,e.n&&(e.n.p=e.p)):t(e.c),e=e.n};var n=function(t){this.l=new e,this.z=t};n.prototype.add=function(t){t.node=this.l.add(t)};var r=function(t){this.bitmap=t,this.anchor={x:.5,y:.5},this.position={x:0,y:0},this.rotation=0,this.scale={x:1,y:1},this.tint=16777215,this.alpha=1,this.visible=!0,this.node=null};r.prototype.remove=function(){this.node&&this.node.remove()};var i=function(t,e){var r=t.getContext("webgl",e),i=r.getExtension("ANGLE_instanced_arrays"),a=function(t,e){var n=r.createShader(e);return r.shaderSource(n,t),r.compileShader(n),n},o=function(t,e,n){var i=r.createBuffer();return r.bindBuffer(t,i),r.bufferData(t,e,n),i},u=[],c=function(t){var e=u.find(function(e){return e.z===t});if(e)return e;var r=new n(t);return u.push(r),u.sort(function(t,e){return t.z<e.z?-1:t.z>e.z?1:0}),r},h=c(0),f=function(t,e){var n=a(t,r.VERTEX_SHADER),i=a(e,r.FRAGMENT_SHADER),o=r.createProgram();return r.attachShader(o,n),r.attachShader(o,i),r.linkProgram(o),o}("precision mediump float;\nattribute vec2 g;\nattribute vec2 a;\nattribute vec2 t;\nattribute float r;\nattribute vec2 s;\nattribute vec4 u;\nattribute vec4 c;\nuniform mat4 m;\nvarying vec2 v;\nvarying vec4 vc;\nvoid main(){\nv=u.xy+g*u.zw;\nvc=c.abgr;\nvec2 p=(g-a)*s;\nfloat cr=cos(r);\nfloat sr=sin(r);\np=vec2(p.x*cr-p.y*sr,p.x*sr+p.y*cr);\np+=a+t;\ngl_Position=m*vec4(p,0,1);}","precision mediump float;\nuniform sampler2D x;\nvarying vec2 v;\nvarying vec4 vc;\nvoid main(){\ngl_FragColor=texture2D(x,v)*vc;}"),s=function(t,e,n,a,o,u,c){var h=r.getAttribLocation(f,t);return r.enableVertexAttribArray(h),r.vertexAttribPointer(h,e,u||r.FLOAT,!!c,n||0,o||0),a&&i.vertexAttribDivisorANGLE(h,a),h};o(r.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,1,3]),r.STATIC_DRAW),o(r.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),r.STATIC_DRAW),s("g",2);var v=new ArrayBuffer(3145680),E=new Float32Array(v),d=new Uint32Array(v);o(r.ARRAY_BUFFER,v,r.DYNAMIC_DRAW),s("a",2,48,1),s("s",2,48,1,8),s("r",1,48,1,16),s("t",2,48,1,20),s("u",4,48,1,28),s("c",4,48,1,44,r.UNSIGNED_BYTE,!0);var p,T=r.getUniformLocation(f,"m"),R=r.getUniformLocation(f,"x"),l=0,A=function(){l&&(r.bufferSubData(r.ARRAY_BUFFER,0,E.subarray(0,12*l)),i.drawElementsInstancedANGLE(r.TRIANGLES,6,r.UNSIGNED_SHORT,0,l),l=0)},_=function(){var e=t.clientWidth,n=t.clientHeight;t.width=e,t.height=n,r.viewport(0,0,e,n),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.clear(r.COLOR_BUFFER_BIT);var i=[2/e,0,0,0,0,-2/n,0,0,0,0,1,0,-1,1,0,1];r.useProgram(f),r.activeTexture(r.TEXTURE0),r.uniformMatrix4fv(T,!1,i),p=null,u.forEach(function(t){return t.l.iterate(function(t){return function(t){if(t.visible){65535===l&&A();var e=t.bitmap,n=e.tex,i=e.width,a=e.height,o=e.uvs;p!==n&&(A(),p=n,r.bindTexture(r.TEXTURE_2D,n),r.uniform1i(R,n));var u=12*l;E[u++]=t.anchor.x,E[u++]=t.anchor.y,E[u++]=t.scale.x*i,E[u++]=t.scale.y*a,E[u++]=t.rotation,E[u++]=t.position.x,E[u++]=t.position.y,E[u++]=o[0],E[u++]=o[1],E[u++]=o[2],E[u++]=o[3],d[u++]=((16777215&t.tint)<<8|255*t.alpha&255)>>>0,l++}}(t)})}),A()};return _(),{gl:r,bkg:function(t,e,n){r.clearColor(t,e,n,1)},texture:function(t,e,n,i,a){var o=r.createTexture();return r.bindTexture(r.TEXTURE_2D,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,e||r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,n||r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,a||r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,i||r.LINEAR),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),r.generateMipmap(r.TEXTURE_2D),{tex:o,width:t.width,height:t.height,uvs:[0,0,1,1]}},bitmap:function(t,e,n,r,i){var a=r-e+1,o=i-n+1;return{tex:t.tex,width:a,height:o,uvs:[e/t.width,n/t.height,a/t.width,o/t.height]}},layer:c,add:function(t){h.add(t)},render:_}};return i.Sprite=r,i});
